<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тренировочный дневник</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            padding: 0;
            margin: 0 auto;
            position: relative;
            min-height: 100vh;
            padding-bottom: 60px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .athlete-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .athlete-selector select {
            flex: 1;
            margin-bottom: 0;
        }

        .athlete-buttons {
            display: flex;
            gap: 5px;
        }

        .page {
            display: none;
            padding: 15px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--border-color);
        }

        h2 {
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        h3 {
            margin: 15px 0 10px 0;
            font-size: 1.3rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        h4 {
            margin: 12px 0 8px 0;
            font-size: 1.1rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            gap: 6px;
            min-height: 40px;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-height: 32px;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.8rem;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            margin-bottom: 4px;
        }

        select,
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .exercise-item,
        .set-item {
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            margin-bottom: 10px;
        }

        .set-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .stats-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stats-controls select {
            margin-bottom: 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }

        .db-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .hidden {
            display: none;
        }

        .date-picker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .date-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color 0.2s ease;
        }

        .date-btn:hover {
            background-color: #2980b9;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #777;
        }

        .workout-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .workout-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .date-actions {
            display: flex;
            gap: 8px;
        }

        .exercise-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .set-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .sets-container {
            margin-top: 12px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .icon-btn {
            background: none;
            border: none;
            padding: 6px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .workout-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .edit-workout-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .edit-workout-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .exercise-summary {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .exercise-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .exercise-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        /* Стили для перетаскивания */
        .exercise-summary.dragging {
            opacity: 0.6;
            background-color: rgba(52, 152, 219, 0.2);
            border: 2px dashed var(--primary-color);
        }

        .exercise-summary.drag-over {
            border: 2px solid var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .drag-handle {
            cursor: grab;
            padding: 8px;
            color: var(--secondary-color);
            opacity: 0.6;
            transition: opacity 0.2s ease;
            user-select: none;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-handle:hover {
            opacity: 1;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Анимации */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .set-controls {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .db-actions {
                grid-template-columns: 1fr;
            }

            .stats-controls {
                flex-direction: column;
            }

            .workout-actions {
                flex-direction: column;
            }

            .form-actions {
                flex-direction: column;
            }

            .athlete-selector {
                flex-direction: column;
            }

            .athlete-buttons {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Theme Color -->
    <meta name="theme-color" content="#3498db">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <!-- Viewport для PWA -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
</head>

<body>
    <div class="container">
        <header>
            <p>Дневник тренировок</p>
        </header>

        <!-- Страница 1: Тренировка на сегодня -->
        <div id="page-today" class="page active">
            <div class="card">
                <h2>Тренировка на сегодня</h2>
                <div id="today-workout">
                    <div class="loading">Загрузка...</div>
                </div>
            </div>
        </div>

        <!-- Страница 2: Добавление/редактирование тренировки -->
        <div id="page-add" class="page">
            <div class="card">
                <div class="workout-header">
                    <h2 id="add-edit-title">Добавить тренировку</h2>
                    <div id="edit-indicator" class="hidden">
                        <span style="color: var(--warning-color); font-weight: 500;">Режим редактирования</span>
                    </div>
                </div>

                <div class="date-picker">
                    <button class="date-btn" id="prev-date">←</button>
                    <input type="date" id="workout-date" value="">
                    <button class="date-btn" id="next-date">→</button>
                </div>

                <div id="exercises-container">
                    <!-- Упражнения будут добавляться здесь -->
                </div>

                <div class="form-actions">
                    <button class="btn" id="add-exercise">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                        Добавить упражнение
                    </button>

                    <div class="workout-actions">
                        <button class="btn btn-danger" id="cancel-edit" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg>
                            Отмена
                        </button>
                        <button class="btn btn-success" id="save-workout">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                            </svg>
                            Сохранить тренировку
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница 3: История тренировок -->
        <div id="page-history" class="page">
            <div class="card">
                <h2>История тренировок</h2>
                <div id="workouts-list">
                    <div class="loading">Загрузка...</div>
                </div>
            </div>
        </div>

        <!-- Страница 4: Статистика -->
        <div id="page-stats" class="page">
            <div class="card">
                <h2>Статистика</h2>
                <div class="stats-controls">
                    <select id="exercise-select">
                        <option value="">Выберите упражнение</option>
                    </select>
                    <select id="months-select">
                        <option value="3">3 месяца</option>
                        <option value="6" selected>6 месяцев</option>
                        <option value="12">12 месяцев</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="progress-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Страница 5: Управление БД -->
        <div id="page-db" class="page">
            <!-- Селектор спортсмена -->
            <div class="athlete-selector">
                <select id="athlete-select">
                    <option value="">Выберите спортсмена</option>
                </select>
                <div class="athlete-buttons">
                    <button class="btn btn-success btn-sm" id="add-athlete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                    </button>
                    <button class="btn btn-danger btn-sm" id="delete-athlete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="CurrentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="card">
                <h2>Управление данными</h2>
                <div class="db-actions">
                    <button class="btn" id="export-all-data">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                        </svg>
                        Экспорт всей базы
                    </button>
                    <button class="btn" id="export-athlete-data">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                        </svg>
                        Экспорт тренировок спортсмена
                    </button>
                    <button class="btn" id="import-file">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                        </svg>
                        Импорт тренировок
                    </button>
                    <button class="btn btn-danger" id="clear-data">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                        </svg>
                        Очистить все данные
                    </button>
                </div>
                <input type="file" id="file-input" class="hidden" accept=".json">
            </div>
        </div>

        <!-- Навигация -->
        <div class="nav">
            <a href="#" class="nav-item active" data-page="page-today">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zm0-12H5V5h14v2zm-7 4H7v5h5v-5z" />
                </svg>
                <span>Сегодня</span>
            </a>
            <a href="#" class="nav-item" data-page="page-add">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
                <span>Добавить</span>
            </a>
            <a href="#" class="nav-item" data-page="page-history">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
                </svg>
                <span>История</span>
            </a>
            <a href="#" class="nav-item" data-page="page-stats">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
                <span>Статистика</span>
            </a>
            <a href="#" class="nav-item" data-page="page-db">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5h-1.5V14h-1v3H8v-3H7v4.5H5.5v-5c0-.55.45-1 1-1H11c.55 0 1 .45 1 1v5zm3.5 0H14v-6h3.5c.55 0 1 .45 1 1V16c0 .55-.45 1-1 1h-2v1.5zm-1-8c0 .55-.45 1-1 1H10V10h3V9h-2V8h2V7h-3V5.5h3.5c.55 0 1 .45 1 1v4zm1 3.5H17v1.5h-1.5z" />
                </svg>
                <span>Данные</span>
            </a>
        </div>
    </div>

    <script>
        // Константы и глобальные переменные
        const DB_NAME = 'WorkoutTrackerDB';
        const DB_VERSION = 2;
        const EXERCISES = [
            'Жим штанги лежа',
            'Жим штанги узким хватом',
            'Жим штанги под углом',
            'Жим штанги сидя',
            'Жим гантелей сидя',
            'Жим гантелей лежа',
            'Жим гантелей под углом',
            'Разводка гантелей лежа',
            'Разводка гантелей под углом',
            'Французский жим',
            'Приседания со штангой',
            'Фронтальный подъем рук',
            'Тяга',
            'Тяга рывковая',
            'Наклоны со штангой стоя',
            'Гиперэкстензия',
            'Другое'
        ];
        const WEIGHTS = [0, 1.25, 2, 2.5, 5, 6, 8, 10, 12, 15, 20, 25, 30];
        for (let i = 35; i <= 150; i += 5) WEIGHTS.push(i);
        const REPS = [1, 2, 3, 4, 6, 8, 10, 12, 14, 16];
        const SETS = [1, 2, 3, 4, 5, 6];

        let db = null;
        let dbReady = false;
        let currentWorkout = {
            date: new Date().toISOString().split('T')[0],
            athleteId: null,
            exercises: []
        };
        let progressChart = null;
        let editingWorkoutId = null;
        let isEditing = false;
        let currentAthleteId = null;

        // Переменные для touch-перетаскивания
        let draggedElement = null;
        let touchStartY = 0;
        let touchCurrentY = 0;
        let isDragging = false;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            setupNavigation();
            setupEventListeners();
            setDefaultDate();
            initDB().then(() => {
                dbReady = true;
                loadAthletes();
                updateUIForAthlete();
            }).catch(error => {
                console.error('Ошибка инициализации БД:', error);
                showError('today-workout', 'Ошибка загрузки данных');
                showError('workouts-list', 'Ошибка загрузки данных');
            });
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <p>${message}</p>
                </div>
            `;
        }

        // Инициализация IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Ошибка открытия базы данных:', event.target.error);
                    reject(event.target.error);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    // Создаем хранилище для спортсменов
                    if (!db.objectStoreNames.contains('athletes')) {
                        const athleteStore = db.createObjectStore('athletes', { keyPath: 'id', autoIncrement: true });
                        athleteStore.createIndex('name', 'name', { unique: true });
                    }

                    // Создаем хранилище для тренировок
                    if (!db.objectStoreNames.contains('workouts')) {
                        const workoutStore = db.createObjectStore('workouts', { keyPath: 'id', autoIncrement: true });
                        workoutStore.createIndex('date', 'date', { unique: false });
                        workoutStore.createIndex('athleteId', 'athleteId', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('База данных успешно открыта');
                    resolve();
                };
            });
        }

        function checkDB() {
            if (!dbReady) {
                throw new Error('База данных не готова');
            }
            return db;
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = item.getAttribute('data-page');
                    showPage(pageId);
                });
            });
        }

        function setActiveNavItem(pageId) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.getAttribute('data-page') === pageId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            // Обновляем активное состояние навигации
            setActiveNavItem(pageId);

            if (pageId === 'page-history') {
                loadWorkoutHistory();
            } else if (pageId === 'page-stats') {
                populateExerciseSelect(); // Обновляем список упражнений
                updateChart(); // Обновляем график
            } else if (pageId === 'page-add' && !isEditing) {
                resetAddForm();
            }
        }

        function setupEventListeners() {
            document.getElementById('add-exercise').addEventListener('click', addExerciseUI);
            document.getElementById('save-workout').addEventListener('click', saveWorkout);
            document.getElementById('workout-date').addEventListener('change', (e) => {
                currentWorkout.date = e.target.value;
            });
            document.getElementById('prev-date').addEventListener('click', () => changeDate(-1));
            document.getElementById('next-date').addEventListener('click', () => changeDate(1));
            document.getElementById('exercise-select').addEventListener('change', updateChart);
            document.getElementById('months-select').addEventListener('change', updateChart);
            document.getElementById('export-all-data').addEventListener('click', exportAllData);
            document.getElementById('export-athlete-data').addEventListener('click', exportAthleteData);
            document.getElementById('import-file').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', importData);
            document.getElementById('clear-data').addEventListener('click', clearData);
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            document.getElementById('add-athlete').addEventListener('click', addAthlete);
            document.getElementById('delete-athlete').addEventListener('click', deleteAthlete);
            document.getElementById('athlete-select').addEventListener('change', athleteSelected);
        }

        function setDefaultDate() {
            const dateInput = document.getElementById('workout-date');
            dateInput.value = currentWorkout.date;
        }

        function changeDate(days) {
            const dateInput = document.getElementById('workout-date');
            const currentDate = new Date(dateInput.value);
            currentDate.setDate(currentDate.getDate() + days);
            const newDate = currentDate.toISOString().split('T')[0];
            dateInput.value = newDate;
            currentWorkout.date = newDate;
        }

        // Функции для работы со спортсменами
        function loadAthletes() {
            try {
                const transaction = checkDB().transaction(['athletes'], 'readonly');
                const store = transaction.objectStore('athletes');
                const request = store.getAll();

                request.onsuccess = () => {
                    const athletes = request.result;
                    const select = document.getElementById('athlete-select');
                    select.innerHTML = '<option value="">Выберите спортсмена</option>';

                    athletes.forEach(athlete => {
                        const option = document.createElement('option');
                        option.value = athlete.id;
                        option.textContent = athlete.name;
                        select.appendChild(option);
                    });

                    if (athletes.length > 0 && !currentAthleteId) {
                        currentAthleteId = athletes[0].id;
                        select.value = currentAthleteId;
                        updateUIForAthlete();
                    } else if (currentAthleteId) {
                        select.value = currentAthleteId;
                        updateUIForAthlete();
                    }
                };

                request.onerror = (error) => {
                    console.error('Ошибка загрузки спортсменов:', error);
                };
            } catch (error) {
                console.error('Ошибка в loadAthletes:', error);
            }
        }

        function addAthlete() {
            const name = prompt('Введите имя спортсмена:');
            if (!name) return;

            try {
                const transaction = checkDB().transaction(['athletes'], 'readwrite');
                const store = transaction.objectStore('athletes');

                const athlete = { name: name.trim() };
                const request = store.add(athlete);

                request.onsuccess = () => {
                    loadAthletes();
                    alert('Спортсмен добавлен!');
                };

                request.onerror = (error) => {
                    console.error('Ошибка добавления спортсмена:', error);
                    alert('Ошибка при добавлении спортсмена');
                };
            } catch (error) {
                console.error('Ошибка в addAthlete:', error);
                alert('Ошибка при добавлении спортсмена');
            }
        }

        function deleteAthlete() {
            const select = document.getElementById('athlete-select');
            const athleteId = parseInt(select.value);

            if (!athleteId) {
                alert('Выберите спортсмена для удаления');
                return;
            }

            if (!confirm('Удалить спортсмена и все его тренировки?')) {
                return;
            }

            try {
                const transaction = checkDB().transaction(['athletes', 'workouts'], 'readwrite');
                const athleteStore = transaction.objectStore('athletes');
                const workoutStore = transaction.objectStore('workouts');

                // Удаляем спортсмена
                athleteStore.delete(athleteId);

                // Удаляем все тренировки спортсмена
                const workoutIndex = workoutStore.index('athleteId');
                const request = workoutIndex.openCursor(IDBKeyRange.only(athleteId));

                request.onsuccess = () => {
                    const cursor = request.result;
                    if (cursor) {
                        workoutStore.delete(cursor.primaryKey);
                        cursor.continue();
                    }
                };

                transaction.oncomplete = () => {
                    currentAthleteId = null;
                    loadAthletes();
                    updateUIForAthlete();
                    alert('Спортсмен и его тренировки удалены');
                };

                transaction.onerror = (error) => {
                    console.error('Ошибка удаления:', error);
                    alert('Ошибка при удалении спортсмена');
                };
            } catch (error) {
                console.error('Ошибка в deleteAthlete:', error);
                alert('Ошибка при удалении спортсмена');
            }
        }

        function athleteSelected() {
            const select = document.getElementById('athlete-select');
            currentAthleteId = parseInt(select.value);
            updateUIForAthlete();
        }

        function updateUIForAthlete() {
            if (currentAthleteId) {
                currentWorkout.athleteId = currentAthleteId;
                loadTodayWorkout();
                loadWorkoutHistory();
                populateExerciseSelect(); // Добавьте эту строку
                updateChart();
            } else {
                // Очищаем UI если спортсмен не выбран
                document.getElementById('today-workout').innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <p>Выберите спортсмена для просмотра тренировок</p>
            </div>
        `;
                document.getElementById('workouts-list').innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <p>Выберите спортсмена для просмотра истории</p>
            </div>
        `;
                // Очищаем список упражнений и график
                document.getElementById('exercise-select').innerHTML = '<option value="">Выберите упражнение</option>';
                const ctx = document.getElementById('progress-chart').getContext('2d');
                if (progressChart) {
                    progressChart.destroy();
                    progressChart = null;
                }
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            }
        }

        // Функции для работы с упражнениями
        function addExerciseUI() {
            const exercisesContainer = document.getElementById('exercises-container');
            const exerciseIndex = currentWorkout.exercises.length;

            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise-item';
            exerciseDiv.setAttribute('data-index', exerciseIndex);
            exerciseDiv.innerHTML = `
                <div class="exercise-header">
                    <select class="exercise-name" required>
                        <option value="">Выберите упражнение</option>
                        ${EXERCISES.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                    </select>
                    <button class="icon-btn remove-exercise" data-index="${exerciseIndex}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
                <div class="sets-container" data-index="${exerciseIndex}">
                    <!-- Подходы будут добавляться здесь -->
                </div>
                <button class="btn btn-sm add-set" data-index="${exerciseIndex}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Добавить подход
                </button>
                <div class="form-actions">
                    <button class="btn btn-success btn-sm save-exercise" data-index="${exerciseIndex}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
                        </svg>
                        OK
                    </button>
                </div>
            `;

            exercisesContainer.appendChild(exerciseDiv);

            exerciseDiv.querySelector('.remove-exercise').addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                removeExercise(index);
            });

            exerciseDiv.querySelector('.add-set').addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                addSetUI(index);
            });

            exerciseDiv.querySelector('.save-exercise').addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                saveExercise(index);
            });

            // Добавляем пустой подход по умолчанию
            addSetUI(exerciseIndex);
        }

        function addSetUI(exerciseIndex) {
            const setsContainer = document.querySelector(`.sets-container[data-index="${exerciseIndex}"]`);
            const setDiv = document.createElement('div');
            setDiv.className = 'set-item';
            setDiv.innerHTML = `
                <div class="set-controls">
                    <select class="set-weight">
                        <option value="">Вес</option>
                        ${WEIGHTS.map(w => `<option value="${w}">${w} кг</option>`).join('')}
                    </select>
                    <select class="set-reps">
                        <option value="">Повторения</option>
                        ${REPS.map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                    <select class="set-count">
                        <option value="">Подходы</option>
                        ${SETS.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                    <button class="icon-btn remove-set">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            `;

            setsContainer.appendChild(setDiv);

            setDiv.querySelector('.remove-set').addEventListener('click', function () {
                setDiv.remove();
            });
        }

        function saveExercise(exerciseIndex) {
            const exerciseDiv = document.querySelectorAll('.exercise-item')[exerciseIndex];
            const name = exerciseDiv.querySelector('.exercise-name').value;

            if (!name) {
                alert('Выберите упражнение');
                return;
            }

            const sets = [];
            const setElements = exerciseDiv.querySelectorAll('.set-item');

            setElements.forEach(setElement => {
                const weight = setElement.querySelector('.set-weight').value;
                const reps = parseInt(setElement.querySelector('.set-reps').value);
                const count = parseInt(setElement.querySelector('.set-count').value);

                if (weight && reps && count) {
                    sets.push({ weight, reps, count });
                }
            });

            if (sets.length === 0) {
                alert('Добавьте хотя бы один подход');
                return;
            }

            // Сворачиваем упражнение в итоговую строку
            exerciseDiv.innerHTML = `
                <div class="exercise-summary" data-index="${exerciseIndex}">
                    <div class="exercise-summary-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="drag-handle">↕️</span>
                            <h4>${name}</h4>
                        </div>
                        <button class="icon-btn edit-exercise" data-index="${exerciseIndex}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="exercise-details">
                        ${sets.map(set => `${set.weight}кг на ${set.count} / ${set.reps} подх.`).join(', ')}
                    </div>
                </div>
            `;

            // Настраиваем перетаскивание для свернутого упражнения
            const summaryElement = exerciseDiv.querySelector('.exercise-summary');
            setupDragAndDrop(summaryElement);

            summaryElement.querySelector('.edit-exercise').addEventListener('click', function () {
                editExercise(exerciseIndex, name, sets);
            });

            // Сохраняем в текущую тренировку
            if (exerciseIndex >= currentWorkout.exercises.length) {
                currentWorkout.exercises.push({ name, sets });
            } else {
                currentWorkout.exercises[exerciseIndex] = { name, sets };
            }
        }

        // Функции для перетаскивания
        function setupDragAndDrop(element) {
            const dragHandle = element.querySelector('.drag-handle');

            // Desktop drag & drop
            dragHandle.addEventListener('dragstart', handleDragStart);
            element.addEventListener('dragend', handleDragEnd);
            element.addEventListener('dragover', handleDragOver);
            element.addEventListener('dragleave', handleDragLeave);
            element.addEventListener('drop', handleDrop);

            // Touch events только для handle
            dragHandle.addEventListener('touchstart', handleTouchStart, { passive: false });
            dragHandle.addEventListener('touchmove', handleTouchMove, { passive: false });
            dragHandle.addEventListener('touchend', handleTouchEnd);
            dragHandle.addEventListener('touchcancel', handleTouchEnd);
        }

        function handleDragStart(e) {
            this.closest('.exercise-summary').classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.closest('.exercise-summary').getAttribute('data-index'));
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.exercise-summary').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            const draggingElement = document.querySelector('.exercise-summary.dragging');
            if (draggingElement && this !== draggingElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave() {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = parseInt(this.getAttribute('data-index'));

            if (fromIndex !== toIndex) {
                moveExercise(fromIndex, toIndex);
            }
        }

        function handleTouchStart(e) {
            if (e.touches.length !== 1) return;

            draggedElement = this.closest('.exercise-summary');
            touchStartY = e.touches[0].clientY;
            touchCurrentY = touchStartY;
            isDragging = true;

            draggedElement.classList.add('dragging');
            e.preventDefault();
        }

        function handleTouchMove(e) {
            if (!isDragging || e.touches.length !== 1) return;

            touchCurrentY = e.touches[0].clientY;
            const deltaY = touchCurrentY - touchStartY;

            // Плавное перемещение элемента
            draggedElement.style.transform = `translateY(${deltaY}px)`;

            // Определяем, над каким элементом находимся
            const elements = document.querySelectorAll('.exercise-summary:not(.dragging)');
            let targetElement = null;
            let minDistance = Infinity;

            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                const elementCenter = rect.top + rect.height / 2;
                const distance = Math.abs(touchCurrentY - elementCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    targetElement = element;
                }
            });

            // Убираем подсветку у всех элементов
            elements.forEach(element => element.classList.remove('drag-over'));

            // Подсвечиваем целевой элемент
            if (targetElement) {
                targetElement.classList.add('drag-over');
            }

            e.preventDefault();
        }

        function handleTouchEnd(e) {
            if (!isDragging) return;

            isDragging = false;
            draggedElement.style.transform = '';
            draggedElement.classList.remove('dragging');

            // Находим целевой элемент для вставки
            const targetElement = document.querySelector('.exercise-summary.drag-over');
            if (targetElement) {
                targetElement.classList.remove('drag-over');

                const fromIndex = parseInt(draggedElement.getAttribute('data-index'));
                const toIndex = parseInt(targetElement.getAttribute('data-index'));

                if (fromIndex !== toIndex) {
                    moveExercise(fromIndex, toIndex);
                }
            }

            // Убираем подсветку у всех элементов на всякий случай
            document.querySelectorAll('.exercise-summary').forEach(item => {
                item.classList.remove('drag-over');
            });

            draggedElement = null;
        }

        function moveExercise(fromIndex, toIndex) {
            // Сохраняем элемент, который перемещаем
            const movedExercise = currentWorkout.exercises[fromIndex];

            // Удаляем его из старой позиции
            currentWorkout.exercises.splice(fromIndex, 1);

            // Вставляем в новую позицию
            currentWorkout.exercises.splice(toIndex, 0, movedExercise);

            // Перерисовываем упражнения
            renderExercises();
        }

        function editExercise(exerciseIndex, name, sets) {
            const exercisesContainer = document.getElementById('exercises-container');
            const exerciseDiv = document.querySelectorAll('.exercise-item')[exerciseIndex];

            exerciseDiv.innerHTML = `
                <div class="exercise-header">
                    <select class="exercise-name" required>
                        <option value="">Выберите упражнение</option>
                        ${EXERCISES.map(ex => `<option value="${ex}" ${ex === name ? 'selected' : ''}>${ex}</option>`).join('')}
                    </select>
                    <button class="icon-btn remove-exercise" data-index="${exerciseIndex}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
                <div class="sets-container" data-index="${exerciseIndex}">
                    ${sets.map((set, setIndex) => `
                        <div class="set-item">
                            <div class="set-controls">
                                <select class="set-weight">
                                    <option value="">Вес</option>
                                    ${WEIGHTS.map(w => `<option value="${w}" ${w === set.weight ? 'selected' : ''}>${w} кг</option>`).join('')}
                                </select>
                                <select class="set-reps">
                                    <option value="">Повторения</option>
                                    ${REPS.map(r => `<option value="${r}" ${r === set.reps ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                                <select class="set-count">
                                    <option value="">Подходы</option>
                                    ${SETS.map(s => `<option value="${s}" ${s === set.count ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                                <button class="icon-btn remove-set">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-sm add-set" data-index="${exerciseIndex}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Добавить подход
                </button>
                <div class="form-actions">
                    <button class="btn btn-success btn-sm save-exercise" data-index="${exerciseIndex}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
                        </svg>
                        OK
                    </button>
                </div>
            `;

            exerciseDiv.querySelector('.remove-exercise').addEventListener('click', function () {
                removeExercise(exerciseIndex);
            });

            exerciseDiv.querySelector('.add-set').addEventListener('click', function () {
                addSetUI(exerciseIndex);
            });

            exerciseDiv.querySelector('.save-exercise').addEventListener('click', function () {
                saveExercise(exerciseIndex);
            });

            exerciseDiv.querySelectorAll('.remove-set').forEach(btn => {
                btn.addEventListener('click', function () {
                    this.closest('.set-item').remove();
                });
            });
        }

        function removeExercise(index) {
            const exercisesContainer = document.getElementById('exercises-container');
            const exerciseDiv = document.querySelectorAll('.exercise-item')[index];
            exerciseDiv.remove();
            currentWorkout.exercises.splice(index, 1);

            // Обновляем индексы у оставшихся упражнений
            document.querySelectorAll('.exercise-item').forEach((div, i) => {
                div.setAttribute('data-index', i);
                const removeBtn = div.querySelector('.remove-exercise');
                const addSetBtn = div.querySelector('.add-set');
                const saveBtn = div.querySelector('.save-exercise');
                const setsContainer = div.querySelector('.sets-container');

                if (removeBtn) removeBtn.setAttribute('data-index', i);
                if (addSetBtn) addSetBtn.setAttribute('data-index', i);
                if (saveBtn) saveBtn.setAttribute('data-index', i);
                if (setsContainer) setsContainer.setAttribute('data-index', i);
            });
        }

        function renderExercises() {
            const container = document.getElementById('exercises-container');
            container.innerHTML = '';

            currentWorkout.exercises.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-item';
                exerciseDiv.setAttribute('data-index', index);
                exerciseDiv.innerHTML = `
                    <div class="exercise-summary" data-index="${index}">
                        <div class="exercise-summary-header">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="drag-handle">↕️</span>
                                <h4>${exercise.name}</h4>
                            </div>
                            <button class="icon-btn edit-exercise" data-index="${index}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="exercise-details">
                            ${exercise.sets.map(set => `${set.weight}кг на ${set.count} / ${set.reps} подх.`).join(', ')}
                        </div>
                    </div>
                `;

                container.appendChild(exerciseDiv);

                // Настраиваем перетаскивание для свернутого упражнения
                const summaryElement = exerciseDiv.querySelector('.exercise-summary');
                setupDragAndDrop(summaryElement);

                summaryElement.querySelector('.edit-exercise').addEventListener('click', function () {
                    editExercise(index, exercise.name, exercise.sets);
                });
            });
        }

        function saveWorkout() {
            if (!currentAthleteId) {
                alert('Выберите спортсмена');
                return;
            }

            if (currentWorkout.exercises.length === 0) {
                alert('Добавьте хотя бы одно упражнение');
                return;
            }

            try {
                const transaction = checkDB().transaction(['workouts'], 'readwrite');
                const store = transaction.objectStore('workouts');

                const workoutToSave = {
                    ...currentWorkout,
                    athleteId: currentAthleteId,
                    date: document.getElementById('workout-date').value
                };

                let request;
                if (isEditing && editingWorkoutId) {
                    workoutToSave.id = editingWorkoutId;
                    request = store.put(workoutToSave);
                } else {
                    request = store.add(workoutToSave);
                }

                request.onsuccess = () => {
                    alert('Тренировка сохранена!');
                    resetAddForm();
                    loadTodayWorkout();
                    loadWorkoutHistory();
                    showPage('page-today');
                };

                request.onerror = (error) => {
                    console.error('Ошибка сохранения тренировки:', error);
                    alert('Ошибка при сохранении тренировки');
                };
            } catch (error) {
                console.error('Ошибка в saveWorkout:', error);
                alert('Ошибка при сохранении тренировки');
            }
        }

        function resetAddForm() {
            document.getElementById('exercises-container').innerHTML = '';
            document.getElementById('workout-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-edit-title').textContent = 'Добавить тренировку';
            document.getElementById('edit-indicator').classList.add('hidden');
            document.getElementById('cancel-edit').style.display = 'none';

            currentWorkout = {
                date: new Date().toISOString().split('T')[0],
                athleteId: currentAthleteId,
                exercises: []
            };

            isEditing = false;
            editingWorkoutId = null;
        }

        function loadTodayWorkout() {
            if (!currentAthleteId) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const index = store.index('athleteId');
                const request = index.getAll(IDBKeyRange.only(currentAthleteId));

                request.onsuccess = () => {
                    const workouts = request.result;
                    const todayWorkout = workouts.find(w => w.date === today);

                    const todayContainer = document.getElementById('today-workout');

                    if (todayWorkout) {
                        todayContainer.innerHTML = `
                            <div class="workout-item">
                                ${todayWorkout.exercises.map(exercise => `
                                    <div class="exercise-summary">
                                        <h4>${exercise.name}</h4>
                                        <div class="exercise-details">
                                            ${exercise.sets.map(set => `${set.weight}кг на ${set.count} / ${set.reps} подх.`).join(', ')}
                                        </div>
                                    </div>
                                `).join('')}
                                <div class="workout-actions">
                                    <button class="btn btn-warning" onclick="editWorkout(${todayWorkout.id})">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                        </svg>
                                        Редактировать
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        todayContainer.innerHTML = `
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <p>Сегодня еще не было тренировки</p>
                                <button class="btn" onclick="showPage('page-add')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                    </svg>
                                    Добавить тренировку
                                </button>
                            </div>
                        `;
                    }
                };

                request.onerror = (error) => {
                    console.error('Ошибка загрузки сегодняшней тренировки:', error);
                    showError('today-workout', 'Ошибка загрузки данных');
                };
            } catch (error) {
                console.error('Ошибка в loadTodayWorkout:', error);
                showError('today-workout', 'Ошибка загрузки данных');
            }
        }

        function loadWorkoutHistory() {
            if (!currentAthleteId) return;

            try {
                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const index = store.index('athleteId');
                const request = index.getAll(IDBKeyRange.only(currentAthleteId));

                request.onsuccess = () => {
                    const workouts = request.result;
                    workouts.sort((a, b) => new Date(b.date) - new Date(a.date));

                    const workoutsList = document.getElementById('workouts-list');

                    if (workouts.length === 0) {
                        workoutsList.innerHTML = `
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <p>Нет сохраненных тренировок</p>
                            </div>
                        `;
                        return;
                    }

                    let currentDate = null;
                    let html = '';

                    workouts.forEach(workout => {
                        const workoutDate = new Date(workout.date).toLocaleDateString('ru-RU');

                        if (workoutDate !== currentDate) {
                            if (currentDate !== null) {
                                html += `</div>`;
                            }
                            html += `
                                <div class="workout-date-header">
                                    <h3>${workoutDate}</h3>
                                </div>
                                <div class="workouts-group">
                            `;
                            currentDate = workoutDate;
                        }

                        html += `
                            <div class="workout-item">
                                <button class="edit-workout-btn" onclick="editWorkout(${workout.id})">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                ${workout.exercises.map(exercise => `
                                    <div class="exercise-summary">
                                        <h4>${exercise.name}</h4>
                                        <div class="exercise-details">
                                            ${exercise.sets.map(set => `${set.weight}кг на ${set.count} / ${set.reps} подх.`).join(', ')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    });

                    if (currentDate !== null) {
                        html += `</div>`;
                    }

                    workoutsList.innerHTML = html;
                };

                request.onerror = (error) => {
                    console.error('Ошибка загрузки истории тренировок:', error);
                    showError('workouts-list', 'Ошибка загрузки данных');
                };
            } catch (error) {
                console.error('Ошибка в loadWorkoutHistory:', error);
                showError('workouts-list', 'Ошибка загрузки данных');
            }
        }

        function editWorkout(workoutId) {
            try {
                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const request = store.get(workoutId);

                request.onsuccess = () => {
                    const workout = request.result;
                    if (workout) {
                        editingWorkoutId = workoutId;
                        isEditing = true;
                        currentWorkout = { ...workout };

                        document.getElementById('workout-date').value = workout.date;
                        document.getElementById('add-edit-title').textContent = 'Редактировать тренировку';
                        document.getElementById('edit-indicator').classList.remove('hidden');
                        document.getElementById('cancel-edit').style.display = 'block';

                        renderExercises();

                        showPage('page-add');
                    }
                };

                request.onerror = (error) => {
                    console.error('Ошибка загрузки тренировки для редактирования:', error);
                    alert('Ошибка при загрузке тренировки');
                };
            } catch (error) {
                console.error('Ошибка в editWorkout:', error);
                alert('Ошибка при загрузке тренировки');
            }
        }

        function cancelEdit() {
            resetAddForm();
            showPage('page-today');
        }

        // Функции для работы с графиком
        function populateExerciseSelect() {
            if (!currentAthleteId) return;

            try {
                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const index = store.index('athleteId');
                const request = index.getAll(IDBKeyRange.only(currentAthleteId));

                request.onsuccess = () => {
                    const workouts = request.result;
                    const exercises = new Set();

                    workouts.forEach(workout => {
                        workout.exercises.forEach(exercise => {
                            exercises.add(exercise.name);
                        });
                    });

                    const select = document.getElementById('exercise-select');
                    const currentValue = select.value;

                    select.innerHTML = '<option value="">Выберите упражнение</option>';
                    exercises.forEach(exercise => {
                        const option = document.createElement('option');
                        option.value = exercise;
                        option.textContent = exercise;
                        select.appendChild(option);
                    });

                    // Восстанавливаем выбранное значение, если оно есть
                    if (currentValue && exercises.has(currentValue)) {
                        select.value = currentValue;
                    }
                };

                request.onerror = (error) => {
                    console.error('Ошибка загрузки упражнений:', error);
                };
            } catch (error) {
                console.error('Ошибка в populateExerciseSelect:', error);
            }
        }

        function updateChart() {
            if (!currentAthleteId) return;

            try {
                const selectedExercise = document.getElementById('exercise-select').value;
                const months = parseInt(document.getElementById('months-select').value);

                if (!selectedExercise) {
                    // Очищаем график если упражнение не выбрано
                    const ctx = document.getElementById('progress-chart').getContext('2d');
                    if (progressChart) {
                        progressChart.destroy();
                        progressChart = null;
                    }
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    return;
                }

                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const index = store.index('athleteId');
                const request = index.getAll(IDBKeyRange.only(currentAthleteId));

                request.onsuccess = () => {
                    const workouts = request.result;
                    const filteredWorkouts = workouts.filter(workout => {
                        const workoutDate = new Date(workout.date);
                        const cutoffDate = new Date();
                        cutoffDate.setMonth(cutoffDate.getMonth() - months);
                        return workoutDate >= cutoffDate;
                    });

                    const exerciseData = [];
                    filteredWorkouts.forEach(workout => {
                        workout.exercises.forEach(exercise => {
                            if (exercise.name === selectedExercise) {
                                const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight)));
                                exerciseData.push({
                                    date: workout.date,
                                    weight: maxWeight,
                                    sets: exercise.sets
                                });
                            }
                        });
                    });

                    exerciseData.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const dates = exerciseData.map(data => new Date(data.date).toLocaleDateString('ru-RU'));
                    const weights = exerciseData.map(data => data.weight);

                    const ctx = document.getElementById('progress-chart').getContext('2d');

                    if (progressChart) {
                        progressChart.destroy();
                    }

                    if (exerciseData.length === 0) {
                        // Показываем сообщение если нет данных
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#777';
                        ctx.textAlign = 'center';
                        ctx.fillText('Нет данных для выбранного упражнения', ctx.canvas.width / 2, ctx.canvas.height / 2);
                        return;
                    }

                    progressChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: `Максимальный вес (${selectedExercise})`,
                                data: weights,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Вес (кг)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Дата'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Прогресс за последние ${months} месяцев`
                                }
                            }
                        }
                    });
                };

                request.onerror = (error) => {
                    console.error('Ошибка загрузки данных для графика:', error);
                };
            } catch (error) {
                console.error('Ошибка в updateChart:', error);
            }
        }

        // Функции для работы с данными
        function exportAllData() {
            try {
                const transaction = checkDB().transaction(['athletes', 'workouts'], 'readonly');
                const athleteStore = transaction.objectStore('athletes');
                const workoutStore = transaction.objectStore('workouts');

                const athleteRequest = athleteStore.getAll();
                const workoutRequest = workoutStore.getAll();

                Promise.all([
                    new Promise(resolve => { athleteRequest.onsuccess = () => resolve(athleteRequest.result); }),
                    new Promise(resolve => { workoutRequest.onsuccess = () => resolve(workoutRequest.result); })
                ]).then(([athletes, workouts]) => {
                    const data = {
                        athletes: athletes,
                        workouts: workouts,
                        exportedAt: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `workout_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            } catch (error) {
                console.error('Ошибка экспорта данных:', error);
                alert('Ошибка при экспорте данных');
            }
        }

        function exportAthleteData() {
            if (!currentAthleteId) {
                alert('Выберите спортсмена');
                return;
            }

            try {
                const transaction = checkDB().transaction(['athletes', 'workouts'], 'readonly');
                const athleteStore = transaction.objectStore('athletes');
                const workoutStore = transaction.objectStore('workouts');
                const workoutIndex = workoutStore.index('athleteId');

                const athleteRequest = athleteStore.get(currentAthleteId);
                const workoutRequest = workoutIndex.getAll(IDBKeyRange.only(currentAthleteId));

                Promise.all([
                    new Promise(resolve => { athleteRequest.onsuccess = () => resolve(athleteRequest.result); }),
                    new Promise(resolve => { workoutRequest.onsuccess = () => resolve(workoutRequest.result); })
                ]).then(([athlete, workouts]) => {
                    const data = {
                        athlete: athlete,
                        workouts: workouts,
                        exportedAt: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `workout_${athlete.name}_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            } catch (error) {
                console.error('Ошибка экспорта данных спортсмена:', error);
                alert('Ошибка при экспорте данных спортсмена');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!data.workouts || !Array.isArray(data.workouts)) {
                        alert('Неверный формат файла');
                        return;
                    }

                    if (!currentAthleteId) {
                        alert('Выберите спортсмена для импорта тренировок');
                        return;
                    }

                    // Функция для безопасной подготовки объекта тренировки
                    function prepareWorkoutForImport(originalWorkout, athleteId) {
                        // Создаем полностью новый объект без лишних свойств
                        return {
                            date: originalWorkout.date,
                            athleteId: athleteId,
                            exercises: Array.isArray(originalWorkout.exercises) ?
                                originalWorkout.exercises.map(exercise => ({
                                    name: String(exercise.name || ''),
                                    sets: Array.isArray(exercise.sets) ?
                                        exercise.sets.map(set => ({
                                            weight: parseFloat(set.weight) || 0,
                                            reps: parseInt(set.reps) || 0,
                                            count: parseInt(set.count) || 0
                                        })) : []
                                })) : []
                        };
                    }

                    try {
                        const checkTransaction = checkDB().transaction(['workouts'], 'readonly');
                        const checkStore = checkTransaction.objectStore('workouts');
                        const getAllRequest = checkStore.getAll();

                        getAllRequest.onsuccess = () => {
                            const existingWorkouts = getAllRequest.result;

                            // Подготавливаем тренировки для импорта
                            const workoutsToImport = data.workouts
                                .map(workout => prepareWorkoutForImport(workout, currentAthleteId))
                                .filter(workout => {
                                    // Фильтруем дубликаты по дате и спортсмену
                                    const isDuplicate = existingWorkouts.some(existing =>
                                        existing.date === workout.date &&
                                        existing.athleteId === workout.athleteId
                                    );
                                    return !isDuplicate;
                                });

                            if (workoutsToImport.length === 0) {
                                alert('Нет новых тренировок для импорта или все тренировки уже существуют');
                                event.target.value = '';
                                return;
                            }

                            // Импортируем тренировки в отдельной транзакции
                            const importTransaction = checkDB().transaction(['workouts'], 'readwrite');
                            const importStore = importTransaction.objectStore('workouts');

                            let importedCount = 0;
                            let errorCount = 0;
                            let duplicateCount = data.workouts.length - workoutsToImport.length;

                            // Импортируем по одной тренировке с задержкой для избежания конфликтов
                            function importNextWorkout(index) {
                                if (index >= workoutsToImport.length) {
                                    let message = `Импорт завершен. Успешно: ${importedCount}`;
                                    if (errorCount > 0) message += `, ошибок: ${errorCount}`;
                                    if (duplicateCount > 0) message += `, пропущено дубликатов: ${duplicateCount}`;

                                    alert(message);
                                    loadTodayWorkout();
                                    loadWorkoutHistory();
                                    updateChart();
                                    return;
                                }

                                const workout = workoutsToImport[index];

                                try {
                                    const request = importStore.add(workout);

                                    request.onsuccess = () => {
                                        importedCount++;
                                        importNextWorkout(index + 1);
                                    };

                                    request.onerror = (e) => {
                                        console.error('Ошибка импорта тренировки:', e.target.error, workout);
                                        errorCount++;
                                        importNextWorkout(index + 1);
                                    };

                                } catch (error) {
                                    console.error('Ошибка при добавлении тренировки:', error, workout);
                                    errorCount++;
                                    importNextWorkout(index + 1);
                                }
                            }

                            // Начинаем импорт
                            importNextWorkout(0);

                        };

                        getAllRequest.onerror = (e) => {
                            console.error('Ошибка загрузки существующих тренировок:', e.target.error);
                            alert('Ошибка при проверке существующих данных');
                        };

                    } catch (error) {
                        console.error('Ошибка импорта:', error);
                        alert('Ошибка при импорте данных');
                    }
                } catch (error) {
                    console.error('Ошибка парсинга файла:', error);
                    alert('Ошибка при чтении файла');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Сбрасываем input
        }

        function clearData() {
            if (!confirm('Вы уверены? Это удалит ВСЕ данные без возможности восстановления.')) {
                return;
            }

            try {
                const transaction = checkDB().transaction(['athletes', 'workouts'], 'readwrite');
                const athleteStore = transaction.objectStore('athletes');
                const workoutStore = transaction.objectStore('workouts');

                athleteStore.clear();
                workoutStore.clear();

                transaction.oncomplete = () => {
                    alert('Все данные удалены');
                    currentAthleteId = null;
                    loadAthletes();
                    updateUIForAthlete();
                };

                transaction.onerror = (error) => {
                    console.error('Ошибка очистки данных:', error);
                    alert('Ошибка при очистке данных');
                };
            } catch (error) {
                console.error('Ошибка в clearData:', error);
                alert('Ошибка при очистке данных');
            }
        }

        // Глобальные функции для использования в onclick
        window.editWorkout = editWorkout;
        window.showPage = showPage;
    </script>
</body>

</html>