<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тренировочный дневник</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            padding: 0;
            margin: 0 auto;
            position: relative;
            min-height: 100vh;
            padding-bottom: 60px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .page {
            display: none;
            padding: 15px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--border-color);
        }

        h2 {
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        h3 {
            margin: 15px 0 10px 0;
            font-size: 1.3rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        h4 {
            margin: 12px 0 8px 0;
            font-size: 1.1rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            gap: 6px;
            min-height: 40px;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-height: 32px;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.8rem;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            margin-bottom: 4px;
        }

        select,
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .exercise-item,
        .set-item {
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            margin-bottom: 10px;
        }

        .set-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .stats-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stats-controls select {
            margin-bottom: 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }

        .db-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .hidden {
            display: none;
        }

        .date-picker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .date-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color 0.2s ease;
        }

        .date-btn:hover {
            background-color: #2980b9;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #777;
        }

        .workout-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .workout-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .date-actions {
            display: flex;
            gap: 8px;
        }

        .exercise-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .set-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .sets-container {
            margin-top: 12px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .icon-btn {
            background: none;
            border: none;
            padding: 6px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .workout-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        /* Анимации */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .set-controls {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .db-actions {
                grid-template-columns: 1fr;
            }

            .stats-controls {
                flex-direction: column;
            }

            .workout-actions {
                flex-direction: column;
            }

            .form-actions {
                flex-direction: column;
            }
        }

        /* Стили для состояний */
        .exercise-item.dragging {
            opacity: 0.5;
            background-color: var(--background-color);
            border: 2px dashed var(--primary-color);
        }

        .exercise-item.drag-over {
            border: 2px dashed var(--primary-color);
        }

        .exercise-item.dragging {
            opacity: 0.5;
            background-color: var(--background-color);
            border: 2px dashed var(--primary-color);
        }

        .exercise-item.drag-over {
            border: 2px solid var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .drag-handle {
            cursor: grab;
            padding: 12px;
            color: var(--secondary-color);
            opacity: 0.6;
            transition: opacity 0.2s ease;
            user-select: none;
            touch-action: none;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .drag-handle:hover {
            opacity: 1;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        @media (max-width: 768px) {
            .drag-handle {
                padding: 16px;
                font-size: 1.4em;
            }
        }

        .exercise-item.drag-over::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary-color);
            z-index: 10;
        }

        /* Улучшенные стили для перетаскивания на мобильных */
        .exercise-item {
            transition: transform 0.2s ease;
            position: relative;
        }

        .exercise-item.dragging {
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <p>Дневник тренировок</p>
        </header>

        <!-- Страница 1: Тренировка на сегодня -->
        <div id="page-today" class="page active">
            <div class="card">
                <h2>Тренировка на сегодня</h2>
                <div id="today-workout">
                    <div class="loading">Загрузка...</div>
                </div>
            </div>
        </div>

        <!-- Страница 2: Добавление/редактирование тренировки -->
        <div id="page-add" class="page">
            <div class="card">
                <div class="workout-header">
                    <h2 id="add-edit-title">Добавить тренировку</h2>
                    <div id="edit-indicator" class="hidden">
                        <span style="color: var(--warning-color); font-weight: 500;">Режим редактирования</span>
                    </div>
                </div>

                <div class="date-picker">
                    <button class="date-btn" id="prev-date">←</button>
                    <input type="date" id="workout-date" value="">
                    <button class="date-btn" id="next-date">→</button>
                </div>

                <div id="exercises-container">
                    <!-- Упражнения будут добавляться здесь -->
                </div>

                <div class="form-actions">
                    <button class="btn" id="add-exercise">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                        Добавить упражнение
                    </button>

                    <div class="workout-actions">
                        <button class="btn btn-danger" id="cancel-edit" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg>
                            Отмена
                        </button>
                        <button class="btn btn-success" id="save-workout">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                            </svg>
                            Сохранить тренировку
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница 3: История тренировок -->
        <div id="page-history" class="page">
            <div class="card">
                <h2>История тренировок</h2>
                <div id="workouts-list">
                    <div class="loading">Загрузка...</div>
                </div>
            </div>
        </div>

        <!-- Страница 4: Статистика -->
        <div id="page-stats" class="page">
            <div class="card">
                <h2>Статистика</h2>
                <div class="stats-controls">
                    <select id="exercise-select">
                        <option value="">Выберите упражнение</option>
                    </select>
                    <select id="months-select">
                        <option value="3">3 месяца</option>
                        <option value="6" selected>6 месяцев</option>
                        <option value="12">12 месяцев</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="progress-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Страница 5: Управление БД -->
        <div id="page-db" class="page">
            <div class="card">
                <h2>Управление данными</h2>
                <div class="db-actions">
                    <button class="btn" id="export-data">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                        </svg>
                        Экспорт данных
                    </button>
                    <button class="btn" id="import-file">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                        </svg>
                        Импорт из файла
                    </button>
                    <button class="btn btn-danger" id="clear-data">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                        </svg>
                        Очистить все данные
                    </button>
                    <button class="btn" id="create-backup">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" />
                        </svg>
                        Создать резервную копию
                    </button>
                </div>
                <input type="file" id="file-input" class="hidden" accept=".json">
            </div>
        </div>

        <!-- Навигация -->
        <div class="nav">
            <a href="#" class="nav-item active" data-page="page-today">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zm0-12H5V5h14v2zm-7 4H7v5h5v-5z" />
                </svg>
                <span>Сегодня</span>
            </a>
            <a href="#" class="nav-item" data-page="page-add">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
                <span>Добавить</span>
            </a>
            <a href="#" class="nav-item" data-page="page-history">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
                </svg>
                <span>История</span>
            </a>
            <a href="#" class="nav-item" data-page="page-stats">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
                <span>Статистика</span>
            </a>
            <a href="#" class="nav-item" data-page="page-db">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5h-1.5V14h-1v3H8v-3H7v4.5H5.5v-5c0-.55.45-1 1-1H11c.55 0 1 .45 1 1v5zm3.5 0H14v-6h3.5c.55 0 1 .45 1 1V16c0 .55-.45 1-1 1h-2v1.5zm-1-8c0 .55-.45 1-1 1H10V10h3V9h-2V8h2V7h-3V5.5h3.5c.55 0 1 .45 1 1v4zm1 3.5H17v1.5h-1.5z" />
                </svg>
                <span>Данные</span>
            </a>
        </div>
    </div>

    <script>
        // Константы и глобальные переменные
        const DB_NAME = 'WorkoutTrackerDB';
        const DB_VERSION = 1;
        const EXERCISES = [
            'Жим штанги лежа',
            'Жим штанги узким хватом',
            'Жим штанги сидя',
            'Жим гантелей сидя'
        ];
        const WEIGHTS = [1.25, 2, 2.5, 5, 6, 8, 10, 12, 15, 20, 25, 30];
        for (let i = 35; i <= 150; i += 5) WEIGHTS.push(i);
        const REPS = [1, 2, 3, 4, 6, 8, 10, 12, 14, 16];
        const SETS = [1, 2, 3, 4, 5, 6];

        let db = null;
        let dbReady = false;
        let currentWorkout = {
            date: new Date().toISOString().split('T')[0],
            exercises: []
        };
        let progressChart = null;
        let editingWorkoutId = null;
        let isEditing = false;
        let touchStartY = 0;
        let touchCurrentY = 0;
        let draggedElement = null;
        let isDragging = false;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            setupNavigation();
            setupEventListeners();
            setDefaultDate();
            initDB().then(() => {
                dbReady = true;
                loadTodayWorkout();
                loadWorkoutHistory();
                populateExerciseSelect();
            }).catch(error => {
                console.error('Ошибка инициализации БД:', error);
                showError('today-workout', 'Ошибка загрузки данных');
                showError('workouts-list', 'Ошибка загрузки данных');
            });
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <p>${message}</p>
                </div>
            `;
        }

        // Инициализация IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Ошибка открытия базы данных:', event.target.error);
                    reject(event.target.error);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('workouts')) {
                        const store = db.createObjectStore('workouts', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('date', 'date', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('База данных успешно открыта');
                    resolve();
                };
            });
        }

        function checkDB() {
            if (!dbReady) {
                throw new Error('База данных не готова');
            }
            return db;
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    navItems.forEach(navItem => navItem.classList.remove('active'));
                    item.classList.add('active');
                    const pageId = item.getAttribute('data-page');
                    showPage(pageId);
                });
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'page-history') {
                loadWorkoutHistory();
            } else if (pageId === 'page-stats') {
                updateChart();
            } else if (pageId === 'page-add' && !isEditing) {
                resetAddForm();
            }
        }

        function setupEventListeners() {
            document.getElementById('add-exercise').addEventListener('click', addExerciseUI);
            document.getElementById('save-workout').addEventListener('click', saveWorkout);
            document.getElementById('workout-date').addEventListener('change', (e) => {
                currentWorkout.date = e.target.value;
            });
            document.getElementById('prev-date').addEventListener('click', () => changeDate(-1));
            document.getElementById('next-date').addEventListener('click', () => changeDate(1));
            document.getElementById('exercise-select').addEventListener('change', updateChart);
            document.getElementById('months-select').addEventListener('change', updateChart);
            document.getElementById('export-data').addEventListener('click', exportData);
            document.getElementById('import-file').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', importData);
            document.getElementById('clear-data').addEventListener('click', clearData);
            document.getElementById('create-backup').addEventListener('click', createBackup);
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
        }

        function setDefaultDate() {
            const dateInput = document.getElementById('workout-date');
            dateInput.value = currentWorkout.date;
        }

        function changeDate(days) {
            const dateInput = document.getElementById('workout-date');
            const currentDate = new Date(dateInput.value);
            currentDate.setDate(currentDate.getDate() + days);
            const newDate = currentDate.toISOString().split('T')[0];
            dateInput.value = newDate;
            currentWorkout.date = newDate;
        }

        // Функции для обработки touch-событий
        function handleTouchStart(e) {
            // Проверяем, что касание произошло именно на элементе drag-handle
            if (e.touches.length !== 1 || !e.target.closest('.drag-handle')) return;

            draggedElement = this;
            touchStartY = e.touches[0].clientY;
            touchCurrentY = touchStartY;
            isDragging = true;

            draggedElement.classList.add('dragging');
            e.preventDefault();
        }

        function handleTouchMove(e) {
            if (!isDragging || e.touches.length !== 1) return;

            touchCurrentY = e.touches[0].clientY;
            const deltaY = touchCurrentY - touchStartY;

            // Плавное перемещение элемента
            draggedElement.style.transform = `translateY(${deltaY}px)`;

            // Определяем, над каким элементом находимся
            const elements = document.querySelectorAll('.exercise-item:not(.dragging)');
            let targetElement = null;
            let minDistance = Infinity;

            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                const elementCenter = rect.top + rect.height / 2;
                const distance = Math.abs(touchCurrentY - elementCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    targetElement = element;
                }
            });

            // Убираем подсветку у всех элементов
            elements.forEach(element => element.classList.remove('drag-over'));

            // Подсвечиваем целевой элемент
            if (targetElement) {
                targetElement.classList.add('drag-over');
            }

            e.preventDefault();
        }

        function handleTouchEnd(e) {
            if (!isDragging) return;

            isDragging = false;
            draggedElement.style.transform = '';
            draggedElement.classList.remove('dragging');

            // Находим целевой элемент для вставки
            const targetElement = document.querySelector('.exercise-item.drag-over');
            if (targetElement) {
                targetElement.classList.remove('drag-over');

                const fromIndex = parseInt(draggedElement.getAttribute('data-index'));
                const toIndex = parseInt(targetElement.getAttribute('data-index'));

                if (fromIndex !== toIndex) {
                    // Сохраняем элемент, который перемещаем
                    const movedExercise = currentWorkout.exercises[fromIndex];

                    // Удаляем его из старой позиции
                    currentWorkout.exercises.splice(fromIndex, 1);

                    // Вставляем в новую позицию
                    currentWorkout.exercises.splice(toIndex, 0, movedExercise);

                    // Перерисовываем упражнения
                    renderExercises();
                }
            }

            // Убираем подсветку у всех элементов на всякий случай
            document.querySelectorAll('.exercise-item').forEach(item => {
                item.classList.remove('drag-over');
            });

            draggedElement = null;
            e.preventDefault();
        }

        function addExerciseUI() {
            const exercisesContainer = document.getElementById('exercises-container');
            const exerciseIndex = currentWorkout.exercises.length;

            currentWorkout.exercises.push({
                name: '',
                sets: []
            });

            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise-item fade-in';
            exerciseDiv.setAttribute('data-index', exerciseIndex);
            exerciseDiv.draggable = true;

            exerciseDiv.innerHTML = `
        <div class="exercise-header">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="drag-handle" style="touch-action: none;">↕️</span>
                <h3>Упражнение ${exerciseIndex + 1}</h3>
            </div>
            <button class="btn btn-danger btn-sm remove-exercise" data-index="${exerciseIndex}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
        <select class="exercise-select" data-index="${exerciseIndex}">
            <option value="">Выберите упражнение</option>
            ${EXERCISES.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
        </select>
        <div class="sets-container" data-index="${exerciseIndex}"></div>
        <button class="btn add-set" data-index="${exerciseIndex}" style="margin-top: 12px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Добавить подход
        </button>
    `;

            exercisesContainer.appendChild(exerciseDiv);

            // Добавляем обработчики для desktop
            setupDragAndDrop(exerciseDiv);

            // Добавляем обработчики для mobile на drag-handle
            const dragHandle = exerciseDiv.querySelector('.drag-handle');
            dragHandle.addEventListener('touchstart', (e) => handleTouchStart.call(exerciseDiv, e), { passive: false });
            dragHandle.addEventListener('touchmove', (e) => handleTouchMove.call(exerciseDiv, e), { passive: false });
            dragHandle.addEventListener('touchend', (e) => handleTouchEnd.call(exerciseDiv, e));
            dragHandle.addEventListener('touchcancel', (e) => handleTouchEnd.call(exerciseDiv, e));

            exerciseDiv.querySelector('.exercise-select').addEventListener('change', (e) => {
                const index = parseInt(e.target.getAttribute('data-index'));
                currentWorkout.exercises[index].name = e.target.value;
            });

            exerciseDiv.querySelector('.add-set').addEventListener('click', (e) => {
                const index = parseInt(e.target.getAttribute('data-index'));
                addSetUI(index);
            });

            exerciseDiv.querySelector('.remove-exercise').addEventListener('click', (e) => {
                const index = parseInt(e.target.getAttribute('data-index'));
                currentWorkout.exercises.splice(index, 1);
                renderExercises();
            });
        }

        function addSetUI(exerciseIndex) {
            const setsContainer = document.querySelector(`.sets-container[data-index="${exerciseIndex}"]`);
            const setIndex = currentWorkout.exercises[exerciseIndex].sets.length;

            currentWorkout.exercises[exerciseIndex].sets.push({
                weight: 0,
                reps: 0,
                sets: 1
            });

            const setDiv = document.createElement('div');
            setDiv.className = 'set-item slide-in';
            setDiv.innerHTML = `
                <div class="set-controls">
                    <select class="weight-select" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                        <option value="">Вес (кг)</option>
                        ${WEIGHTS.map(w => `<option value="${w}">${w}</option>`).join('')}
                    </select>
                    <select class="reps-select" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                        <option value="">Повторения</option>
                        ${REPS.map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                    <select class="sets-select" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                        <option value="">Подходы</option>
                        ${SETS.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                    <button class="btn btn-danger btn-sm remove-set" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            `;

            setsContainer.appendChild(setDiv);

            setDiv.querySelector('.weight-select').addEventListener('change', (e) => {
                const exIndex = parseInt(e.target.getAttribute('data-exercise'));
                const sIndex = parseInt(e.target.getAttribute('data-set'));
                currentWorkout.exercises[exIndex].sets[sIndex].weight = parseFloat(e.target.value);
            });

            setDiv.querySelector('.reps-select').addEventListener('change', (e) => {
                const exIndex = parseInt(e.target.getAttribute('data-exercise'));
                const sIndex = parseInt(e.target.getAttribute('data-set'));
                currentWorkout.exercises[exIndex].sets[sIndex].reps = parseInt(e.target.value);
            });

            setDiv.querySelector('.sets-select').addEventListener('change', (e) => {
                const exIndex = parseInt(e.target.getAttribute('data-exercise'));
                const sIndex = parseInt(e.target.getAttribute('data-set'));
                currentWorkout.exercises[exIndex].sets[sIndex].sets = parseInt(e.target.value);
            });

            setDiv.querySelector('.remove-set').addEventListener('click', (e) => {
                const exIndex = parseInt(e.target.getAttribute('data-exercise'));
                const sIndex = parseInt(e.target.getAttribute('data-set'));
                currentWorkout.exercises[exIndex].sets.splice(sIndex, 1);
                renderExercises();
            });
        }

        function setupDragAndDrop(exerciseDiv) {
            exerciseDiv.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', exerciseDiv.getAttribute('data-index'));
                setTimeout(() => exerciseDiv.classList.add('dragging'), 0);
            });

            exerciseDiv.addEventListener('dragend', () => {
                document.querySelectorAll('.exercise-item').forEach(item => {
                    item.classList.remove('dragging', 'drag-over');
                    item.style.transform = '';
                });
            });

            exerciseDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingItem = document.querySelector('.exercise-item.dragging');
                if (draggingItem && exerciseDiv !== draggingItem) {
                    exerciseDiv.classList.add('drag-over');
                }
            });

            exerciseDiv.addEventListener('dragleave', () => {
                exerciseDiv.classList.remove('drag-over');
            });

            exerciseDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                exerciseDiv.classList.remove('drag-over');

                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const toIndex = parseInt(exerciseDiv.getAttribute('data-index'));

                if (fromIndex !== toIndex) {
                    // Сохраняем элемент, который перемещаем
                    const movedExercise = currentWorkout.exercises[fromIndex];

                    // Удаляем его из старой позиции
                    currentWorkout.exercises.splice(fromIndex, 1);

                    // Вставляем в новую позицию
                    currentWorkout.exercises.splice(toIndex, 0, movedExercise);

                    // Перерисовываем упражнения
                    renderExercises();
                }
            });
        }

        function renderExercises() {
            const container = document.getElementById('exercises-container');
            container.innerHTML = '';

            currentWorkout.exercises.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-item fade-in';
                exerciseDiv.setAttribute('data-index', index);
                exerciseDiv.draggable = true;

                exerciseDiv.innerHTML = `
            <div class="exercise-header">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="drag-handle" style="touch-action: none;">↕️</span>
                    <h3>Упражнение ${index + 1}</h3>
                </div>
                <button class="btn btn-danger btn-sm remove-exercise" data-index="${index}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <select class="exercise-select" data-index="${index}">
                <option value="">Выберите упражнение</option>
                ${EXERCISES.map(ex =>
                    `<option value="${ex}" ${ex === exercise.name ? 'selected' : ''}>${ex}</option>`
                ).join('')}
            </select>
            <div class="sets-container" data-index="${index}">
                ${renderSets(exercise.sets, index)}
            </div>
            <button class="btn add-set" data-index="${index}" style="margin-top: 12px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Добавить подход
            </button>
        `;

                container.appendChild(exerciseDiv);

                // Назначаем обработчики
                exerciseDiv.querySelector('.exercise-select').addEventListener('change', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'));
                    currentWorkout.exercises[idx].name = e.target.value;
                });

                exerciseDiv.querySelector('.add-set').addEventListener('click', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'));
                    addSetUI(idx);
                });

                exerciseDiv.querySelector('.remove-exercise').addEventListener('click', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'));
                    currentWorkout.exercises.splice(idx, 1);
                    renderExercises();
                });

                // Добавляем обработчики для desktop
                setupDragAndDrop(exerciseDiv);

                // Добавляем обработчики для mobile на drag-handle
                const dragHandle = exerciseDiv.querySelector('.drag-handle');
                dragHandle.addEventListener('touchstart', (e) => handleTouchStart.call(exerciseDiv, e), { passive: false });
                dragHandle.addEventListener('touchmove', (e) => handleTouchMove.call(exerciseDiv, e), { passive: false });
                dragHandle.addEventListener('touchend', (e) => handleTouchEnd.call(exerciseDiv, e));
                dragHandle.addEventListener('touchcancel', (e) => handleTouchEnd.call(exerciseDiv, e));
            });
        }

        function renderSets(sets, exerciseIndex) {
            return sets.map((set, setIndex) => `
                <div class="set-item">
                    <div class="set-controls">
                        <select class="weight-select" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                            <option value="">Вес (кг)</option>
                            ${WEIGHTS.map(w =>
                `<option value="${w}" ${w === set.weight ? 'selected' : ''}>${w}</option>`
            ).join('')}
                        </select>
                        <select class="reps-select" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                            <option value="">Повторения</option>
                            ${REPS.map(r =>
                `<option value="${r}" ${r === set.reps ? 'selected' : ''}>${r}</option>`
            ).join('')}
                        </select>
                        <select class="sets-select" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                            <option value="">Подходы</option>
                            ${SETS.map(s =>
                `<option value="${s}" ${s === set.sets ? 'selected' : ''}>${s}</option>`
            ).join('')}
                        </select>
                        <button class="btn btn-danger btn-sm remove-set" data-exercise="${exerciseIndex}" data-set="${setIndex}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function saveWorkout() {
            // Валидация
            let isValid = true;
            let errorMessage = '';

            currentWorkout.exercises.forEach((exercise, exIndex) => {
                if (!exercise.name) {
                    isValid = false;
                    errorMessage = 'Пожалуйста, выберите упражнение для всех добавленных упражнений';
                    return;
                }
                exercise.sets.forEach((set, setIndex) => {
                    if (!set.weight || !set.reps || !set.sets) {
                        isValid = false;
                        errorMessage = 'Пожалуйста, заполните все поля для подходов';
                        return;
                    }
                });
            });

            if (!isValid) {
                alert(errorMessage);
                return;
            }

            try {
                const transaction = checkDB().transaction(['workouts'], 'readwrite');
                const store = transaction.objectStore('workouts');

                let request;
                if (isEditing) {
                    request = store.put({
                        id: editingWorkoutId,
                        date: currentWorkout.date,
                        exercises: currentWorkout.exercises
                    });
                } else {
                    request = store.add({
                        date: currentWorkout.date,
                        exercises: currentWorkout.exercises
                    });
                }

                request.onsuccess = () => {
                    alert(`Тренировка успешно ${isEditing ? 'обновлена' : 'сохранена'}!`);
                    resetAddForm();
                    loadTodayWorkout();
                    loadWorkoutHistory();
                    showPage('page-history');
                };

                request.onerror = (event) => {
                    console.error('Ошибка сохранения тренировки:', event.target.error);
                    alert('Произошла ошибка при сохранении тренировки');
                };
            } catch (error) {
                console.error('Ошибка доступа к БД:', error);
                alert('База данных не доступна');
            }
        }

        function resetAddForm() {
            currentWorkout = {
                date: new Date().toISOString().split('T')[0],
                exercises: []
            };
            editingWorkoutId = null;
            isEditing = false;

            document.getElementById('exercises-container').innerHTML = '';
            document.getElementById('workout-date').value = currentWorkout.date;
            document.getElementById('add-edit-title').textContent = 'Добавить тренировку';
            document.getElementById('cancel-edit').style.display = 'none';
            document.getElementById('edit-indicator').classList.add('hidden');
        }

        function cancelEdit() {
            resetAddForm();
            showPage('page-history');
        }

        function loadTodayWorkout() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const index = store.index('date');
                const request = index.getAll(today);

                request.onsuccess = () => {
                    const container = document.getElementById('today-workout');
                    container.innerHTML = '';

                    if (request.result.length > 0) {
                        const workout = request.result[0];
                        workout.exercises.forEach(exercise => {
                            const exerciseDiv = document.createElement('div');
                            exerciseDiv.className = 'exercise-item';

                            let setsHTML = '';
                            exercise.sets.forEach(set => {
                                setsHTML += `
                                    <div class="set-display">
                                        <span>${set.weight}кг × ${set.reps} повторений</span>
                                        <span>${set.sets} подходов</span>
                                    </div>
                                `;
                            });

                            exerciseDiv.innerHTML = `
                                <h3>${exercise.name}</h3>
                                ${setsHTML}
                            `;
                            container.appendChild(exerciseDiv);
                        });
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"/>
                                </svg>
                                <p>На сегодня тренировок не запланировано</p>
                            </div>
                        `;
                    }
                };
            } catch (error) {
                showError('today-workout', 'Ошибка загрузки данных');
            }
        }

        function loadWorkoutHistory() {
            try {
                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const request = store.getAll();

                request.onsuccess = () => {
                    const container = document.getElementById('workouts-list');
                    container.innerHTML = '';

                    if (request.result.length > 0) {
                        const workoutsByDate = {};
                        request.result.forEach(workout => {
                            if (!workoutsByDate[workout.date]) {
                                workoutsByDate[workout.date] = [];
                            }
                            workoutsByDate[workout.date].push(workout);
                        });

                        const sortedDates = Object.keys(workoutsByDate).sort().reverse();

                        sortedDates.forEach(date => {
                            const dateDiv = document.createElement('div');
                            dateDiv.className = 'workout-date';

                            const dateHeader = document.createElement('div');
                            dateHeader.className = 'workout-date-header';
                            dateHeader.innerHTML = `
                                <h3>${formatDate(date)}</h3>
                                <div class="date-actions"></div>
                            `;
                            dateDiv.appendChild(dateHeader);

                            workoutsByDate[date].forEach(workout => {
                                const workoutDiv = document.createElement('div');
                                workoutDiv.className = 'workout-item slide-in';

                                let exercisesHTML = '';
                                workout.exercises.forEach(exercise => {
                                    let setsHTML = '';
                                    exercise.sets.forEach(set => {
                                        setsHTML += `<div class="set-display">
                                            <span>${set.weight}кг × ${set.reps} повторений</span>
                                            <span>${set.sets} подходов</span>
                                        </div>`;
                                    });

                                    exercisesHTML += `
                                        <div class="exercise-item">
                                            <h4>${exercise.name}</h4>
                                            ${setsHTML}
                                        </div>
                                    `;
                                });

                                // Добавляем кнопку редактирования в заголовок даты
                                const editButton = document.createElement('button');
                                editButton.className = 'btn btn-warning btn-sm';
                                editButton.innerHTML = `
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                    Редактировать
                                `;
                                editButton.setAttribute('data-id', workout.id);

                                dateHeader.querySelector('.date-actions').appendChild(editButton);

                                workoutDiv.innerHTML = exercisesHTML;
                                dateDiv.appendChild(workoutDiv);
                            });

                            container.appendChild(dateDiv);
                        });

                        // Назначаем обработчики для кнопок редактирования
                        document.querySelectorAll('.btn-warning[data-id]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const workoutId = parseInt(e.currentTarget.getAttribute('data-id'));
                                editWorkout(workoutId);
                            });
                        });
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"/>
                                </svg>
                                <p>Нет сохраненных тренировок</p>
                            </div>
                        `;
                    }
                };
            } catch (error) {
                showError('workouts-list', 'Ошибка загрузки данных');
            }
        }

        function editWorkout(workoutId) {
            try {
                const transaction = checkDB().transaction(['workouts'], 'readwrite');
                const store = transaction.objectStore('workouts');
                const request = store.get(workoutId);

                request.onsuccess = (event) => {
                    const workout = event.target.result;
                    if (workout) {
                        editingWorkoutId = workoutId;
                        isEditing = true;
                        currentWorkout = JSON.parse(JSON.stringify(workout));

                        document.getElementById('workout-date').value = currentWorkout.date;
                        document.getElementById('add-edit-title').textContent = 'Редактировать тренировку';
                        document.getElementById('cancel-edit').style.display = 'inline-flex';
                        document.getElementById('edit-indicator').classList.remove('hidden');

                        renderExercises();

                        showPage('page-add');
                    }
                };
            } catch (error) {
                console.error('Ошибка загрузки тренировки для редактирования:', error);
                alert('Ошибка при загрузке тренировки');
            }
        }

        // Остальные функции остаются без изменений
        function populateExerciseSelect() {
            const exerciseSelect = document.getElementById('exercise-select');
            while (exerciseSelect.options.length > 1) {
                exerciseSelect.remove(1);
            }
            EXERCISES.forEach(exercise => {
                const option = document.createElement('option');
                option.value = exercise;
                option.textContent = exercise;
                exerciseSelect.appendChild(option);
            });
        }

        function updateChart() {
            const exerciseName = document.getElementById('exercise-select').value;
            const months = parseInt(document.getElementById('months-select').value);

            if (!exerciseName) {
                const ctx = document.getElementById('progress-chart').getContext('2d');
                if (progressChart) progressChart.destroy();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#777';
                ctx.textAlign = 'center';
                ctx.fillText('Выберите упражнение для отображения статистики', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            getExerciseProgressData(exerciseName, months).then(data => {
                renderProgressChart(data, exerciseName);
            }).catch(error => {
                console.error('Ошибка получения данных для графика:', error);
            });
        }

        function getExerciseProgressData(exerciseName, months) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = checkDB().transaction(['workouts'], 'readonly');
                    const store = transaction.objectStore('workouts');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const result = [];
                        const now = new Date();
                        const cutoffDate = new Date();
                        cutoffDate.setMonth(now.getMonth() - months);

                        request.result.forEach(workout => {
                            const workoutDate = new Date(workout.date);
                            if (workoutDate >= cutoffDate) {
                                workout.exercises.forEach(exercise => {
                                    if (exercise.name === exerciseName) {
                                        let maxWeight = 0;
                                        exercise.sets.forEach(set => {
                                            if (set.weight > maxWeight) maxWeight = set.weight;
                                        });
                                        if (maxWeight > 0) {
                                            result.push({ date: workout.date, weight: maxWeight });
                                        }
                                    }
                                });
                            }
                        });

                        result.sort((a, b) => new Date(a.date) - new Date(b.date));
                        resolve(result);
                    };

                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function renderProgressChart(data, exerciseName) {
            const ctx = document.getElementById('progress-chart').getContext('2d');
            if (progressChart) progressChart.destroy();

            if (data.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#777';
                ctx.textAlign = 'center';
                ctx.fillText('Нет данных для отображения', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const labels = data.map(item => formatDate(item.date));
            const weights = data.map(item => item.weight);

            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Макс. вес в ${exerciseName} (кг)`,
                        data: weights,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Вес (кг)' } },
                        x: { title: { display: true, text: 'Дата' } }
                    }
                }
            });
        }

        function exportData() {
            try {
                const transaction = checkDB().transaction(['workouts'], 'readonly');
                const store = transaction.objectStore('workouts');
                const request = store.getAll();

                request.onsuccess = () => {
                    const data = JSON.stringify(request.result, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'workout-data.json';
                    a.click();
                    URL.revokeObjectURL(url);
                };
            } catch (error) {
                console.error('Ошибка экспорта данных:', error);
                alert('Ошибка экспорта данных');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        const transaction = checkDB().transaction(['workouts'], 'readwrite');
                        const store = transaction.objectStore('workouts');
                        store.clear();
                        data.forEach(workout => store.add(workout));
                        transaction.oncomplete = () => {
                            alert('Данные успешно импортированы!');
                            loadTodayWorkout();
                            loadWorkoutHistory();
                            updateChart();
                        };
                    } else {
                        alert('Некорректный формат данных');
                    }
                } catch (error) {
                    console.error('Ошибка импорта данных:', error);
                    alert('Произошла ошибка при импорте данных');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearData() {
            if (confirm('Вы уверены, что хотите удалить все данные? Это действие нельзя отменить.')) {
                try {
                    const transaction = checkDB().transaction(['workouts'], 'readwrite');
                    const store = transaction.objectStore('workouts');
                    const request = store.clear();
                    request.onsuccess = () => {
                        alert('Все данные успешно удалены');
                        loadTodayWorkout();
                        loadWorkoutHistory();
                        updateChart();
                    };
                } catch (error) {
                    console.error('Ошибка очистки данных:', error);
                    alert('Ошибка очистки данных');
                }
            }
        }

        function createBackup() {
            exportData();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
    </script>
</body>

</html>